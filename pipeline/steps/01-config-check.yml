jobs:

- job:
  pool:
    vmImage: 'ubuntu-latest'

  steps:

  - task: TerraformInstaller@0
    displayName: Install Terraform ${{ parameters.terraformVersion }}
    inputs:
      terraformVersion: ${{ parameters.terraformVersion }}

  - task: Bash@3
    displayName: Terraform fmt
    inputs:
      targetType: inline
      workingDirectory: $(System.DefaultWorkingDirectory)/terraform
      script: terraform fmt -recursive

  - task: TerraformCLI@0
    displayName: terraform init
    inputs:
      command: init
      workingDirectory: $(System.DefaultWorkingDirectory)/terraform
      backendType: azurerm
      backendServiceArm: ${{ parameters.subscription }}
      backendAzureRmResourceGroupName: ${{ parameters.resourcegroup }}
      backendAzureRmResourceGroupLocation: uksouth
      backendAzureRmStorageAccountName: ${{ parameters.storageaccount }}
      backendAzureRmContainerName: tfstate
      backendAzureRmKey: hmi/${{ parameters.environment }}.tfstate

  - task: TerraformCLI@0
    displayName: terraform validate
    inputs:
      command: validate
      workingDirectory: $(System.DefaultWorkingDirectory)/terraform